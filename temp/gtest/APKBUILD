# Maintainer: Francesco Colista <fcolista@alpinelinux.org>
pkgname=gtest
pkgver=1.8.1
pkgrel=0
pkgdesc="Google Test - C++ testing utility based on the xUnit framework (like JUnit)"
url="https://github.com/google/googletest"
arch="all"
options="!check"  # No test suite.
license="BSD-3-Clause"
depends="libgcc bash"
depends_dev="python3 cmake"
makedepends="$depends_dev"
subpackages="gmock $pkgname-dev $pkgname-doc"
source="https://github.com/google/googletest/archive/release-$pkgver.tar.gz
	fix-gtest-cmake-path.patch"

builddir="$srcdir"/googletest-release-$pkgver

build() {
	cd "$builddir"
	rm -rf build && mkdir build
	cd build

	cmake -DBUILD_SHARED_LIBS=ON \
	      -DCMAKE_SKIP_RPATH=ON ../
	make
}

package() {
	cd "$builddir"
	for dir in usr/lib usr/include/$pkgname/internal/custom usr/share/licenses/$pkgname\
			usr/src/$pkgname/cmake usr/src/$pkgname/src; do
		install -d -m 0755 "$pkgdir"/"$dir"
	done
	install -m 0644 build/googlemock/$pkgname/libgtest*.so "$pkgdir"/usr/lib

	install -m 0644 googletest/include/$pkgname/*.h "$pkgdir"/usr/include/$pkgname
	install -m 0644 googletest/include/$pkgname/internal/*.h \
		"$pkgdir"/usr/include/$pkgname/internal/
	install -m 0644 googletest/include/$pkgname/internal/custom/*.h \
		"$pkgdir"/usr/include/$pkgname/internal/custom/
	install -m 0644 googletest/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/
	install -m 0644 googletest/CMakeLists.txt "$pkgdir"/usr/src/$pkgname/
	install -m 0644 googletest/cmake/* "$pkgdir"/usr/src/$pkgname/cmake/
}

gmock() {
	cd "$builddir"
	for dir in usr/lib usr/include/$subpkgname/internal/custom usr/share/licenses/$subpkgname\
			usr/src/$subpkgname/cmake usr/src/$subpkgname/src; do
		install -d -m 0755 "$subpkgdir"/"$dir"
	done
	install -m 0644 build/googlemock/libgmock*.so "$subpkgdir"/usr/lib
	
	install -m 0644 googlemock/include/$subpkgname/*.h "$subpkgdir"/usr/include/$subpkgname
	install -m 0644 googlemock/include/$subpkgname/internal/*.h \
		"$subpkgdir"/usr/include/$subpkgname/internal/
	install -m 0644 googlemock/include/$subpkgname/internal/custom/*.h \
		"$subpkgdir"/usr/include/$subpkgname/internal/custom/
	install -m 0644 googlemock/LICENSE "$subpkgdir"/usr/share/licenses/$subpkgname/
	install -m 0644 googlemock/CMakeLists.txt "$subpkgdir"/usr/src/$subpkgname/
	install -m 0644 googlemock/cmake/* "$subpkgdir"/usr/src/$subpkgname/cmake/
}

sha512sums="e6283c667558e1fd6e49fa96e52af0e415a3c8037afe1d28b7ff1ec4c2ef8f49beb70a9327b7fc77eb4052a58c4ccad8b5260ec90e4bceeac7a46ff59c4369d7  release-1.8.1.tar.gz
e3ab91202c0b892b9d0fb3c2f2976d8be7bb325b1ef9dcfd091f8cc2e50d911e96f2c05b7a91e1c50803fb4af48c2d9f2c0c569212790e6484fc5044e4ec7d89  fix-gtest-cmake-path.patch"
