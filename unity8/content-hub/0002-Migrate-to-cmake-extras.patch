From f27f5b0a1b219a9d781d90601bebd58de4221565 Mon Sep 17 00:00:00 2001
From: Luca Weiss <luca@z3ntu.xyz>
Date: Sun, 30 Dec 2018 23:56:16 +0100
Subject: [PATCH 2/2] Migrate to cmake-extras

---
 CMakeLists.txt                        |   4 +-
 cmake/EnableCoverageReport.cmake      | 153 --------------------------
 cmake/FindGtest.cmake                 |  67 -----------
 cmake/Findgcovr.cmake                 |  31 ------
 cmake/GSettings.cmake                 |  41 -------
 cmake/ParseArguments.cmake            |  52 ---------
 tests/CMakeLists.txt                  |   3 +-
 tests/acceptance-tests/CMakeLists.txt |   4 +-
 8 files changed, 5 insertions(+), 350 deletions(-)
 delete mode 100644 cmake/EnableCoverageReport.cmake
 delete mode 100644 cmake/FindGtest.cmake
 delete mode 100644 cmake/Findgcovr.cmake
 delete mode 100644 cmake/GSettings.cmake
 delete mode 100644 cmake/ParseArguments.cmake

diff --git a/CMakeLists.txt b/CMakeLists.txt
index df04175..b40a0ca 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -21,8 +21,8 @@ project (content-hub C CXX)
 set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/cmake)
 
 include (GNUInstallDirs)
-include (EnableCoverageReport)
-include (GSettings)
+find_package(CoverageReport)
+find_package(GSettings)
 
 set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fPIC -pthread")
 set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 -fno-strict-aliasing -fPIC -pthread -Wno-unused-function")
diff --git a/cmake/EnableCoverageReport.cmake b/cmake/EnableCoverageReport.cmake
deleted file mode 100644
index b411c21..0000000
--- a/cmake/EnableCoverageReport.cmake
+++ /dev/null
@@ -1,153 +0,0 @@
-# - Creates a special coverage build type and target on GCC.
-#
-# Defines a function ENABLE_COVERAGE_REPORT which generates the coverage target
-# for selected targets. Optional arguments to this function are used to filter
-# unwanted results using globbing expressions. Moreover targets with tests for
-# the source code can be specified to trigger regenerating the report if the
-# test has changed
-#
-# ENABLE_COVERAGE_REPORT(TARGETS target... [FILTER filter...] [TESTS test targets...])
-#
-# To generate a coverage report first build the project with
-# CMAKE_BUILD_TYPE=coverage, then call make test and afterwards make coverage.
-#
-# The coverage report is based on gcov. Depending on the availability of lcov
-# a HTML report will be generated and/or an XML report of gcovr is found.
-# The generated coverage target executes all found solutions. Special targets
-# exist to create e.g. only the xml report: coverage-xml. 
-#
-# Copyright (C) 2010 by Johannes Wienke <jwienke at techfak dot uni-bielefeld dot de>
-#
-# This program is free software; you can redistribute it
-# and/or modify it under the terms of the GNU General
-# Public License as published by the Free Software Foundation;
-# either version 2, or (at your option)
-# any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-
-INCLUDE(ParseArguments)
-
-FIND_PACKAGE(Lcov)
-FIND_PACKAGE(gcovr)
-
-FUNCTION(ENABLE_COVERAGE_REPORT)
-    
-    # argument parsing
-    PARSE_ARGUMENTS(ARG "FILTER;TARGETS;TESTS" "" ${ARGN})
-    
-    SET(COVERAGE_RAW_FILE "${CMAKE_BINARY_DIR}/coverage.raw.info")
-    SET(COVERAGE_FILTERED_FILE "${CMAKE_BINARY_DIR}/coverage.info")
-    SET(COVERAGE_REPORT_DIR "${CMAKE_BINARY_DIR}/coveragereport")
-    SET(COVERAGE_XML_FILE "${CMAKE_BINARY_DIR}/coverage.xml")
-    SET(COVERAGE_XML_COMMAND_FILE "${CMAKE_BINARY_DIR}/coverage-xml.cmake")
-    
-    # decide if there is any tool to create coverage data
-    SET(TOOL_FOUND FALSE)
-    IF(LCOV_FOUND OR GCOVR_FOUND)
-        SET(TOOL_FOUND TRUE)
-    ENDIF()
-    IF(NOT TOOL_FOUND)
-        MESSAGE(STATUS "Cannot enable coverage targets because neither lcov nor gcovr are found.")
-    ENDIF()
-    
-    STRING(TOLOWER "${CMAKE_BUILD_TYPE}" COVERAGE_BUILD_TYPE)
-    IF(CMAKE_COMPILER_IS_GNUCXX AND TOOL_FOUND AND "${COVERAGE_BUILD_TYPE}" MATCHES "coverage")
-    
-        MESSAGE(STATUS "Coverage support enabled for targets: ${ARG_TARGETS}")
-    
-        # create coverage build type
-        SET(CMAKE_CXX_FLAGS_COVERAGE ${CMAKE_CXX_FLAGS_DEBUG} PARENT_SCOPE)
-        SET(CMAKE_C_FLAGS_COVERAGE ${CMAKE_C_FLAGS_DEBUG} PARENT_SCOPE)
-        SET(CMAKE_CONFIGURATION_TYPES ${CMAKE_CONFIGURATION_TYPES} coverage PARENT_SCOPE)
-    
-        # instrument targets
-        SET_TARGET_PROPERTIES(${ARG_TARGETS} PROPERTIES COMPILE_FLAGS --coverage
-                                                        LINK_FLAGS --coverage)
-    
-        # html report
-        IF (LCOV_FOUND)
-        
-            MESSAGE(STATUS "Enabling HTML coverage report")
-    
-            # set up coverage target
-            
-            ADD_CUSTOM_COMMAND(OUTPUT ${COVERAGE_RAW_FILE}
-                               COMMAND ${LCOV_EXECUTABLE} -c -d ${CMAKE_BINARY_DIR} -o ${COVERAGE_RAW_FILE}
-                               WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
-                               COMMENT "Collecting coverage data"
-                               DEPENDS ${ARG_TARGETS} ${ARG_TESTS}
-                               VERBATIM)
-            
-            # filter unwanted stuff
-            LIST(LENGTH ARG_FILTER FILTER_LENGTH)
-            IF(${FILTER_LENGTH} GREATER 0)
-                SET(FILTER COMMAND ${LCOV_EXECUTABLE})
-                FOREACH(F ${ARG_FILTER})
-                    SET(FILTER ${FILTER} -r ${COVERAGE_FILTERED_FILE} ${F})
-                ENDFOREACH()
-                SET(FILTER ${FILTER} -o ${COVERAGE_FILTERED_FILE})
-            ELSE()
-                SET(FILTER "")
-            ENDIF()
-            
-            ADD_CUSTOM_COMMAND(OUTPUT ${COVERAGE_FILTERED_FILE}
-                               COMMAND ${LCOV_EXECUTABLE} -e ${COVERAGE_RAW_FILE} "${CMAKE_SOURCE_DIR}*"  -o ${COVERAGE_FILTERED_FILE}
-                               ${FILTER}
-                               DEPENDS ${COVERAGE_RAW_FILE}
-                               COMMENT "Filtering recorded coverage data for project-relevant entries"
-                               VERBATIM)
-            ADD_CUSTOM_COMMAND(OUTPUT ${COVERAGE_REPORT_DIR}
-                               COMMAND ${CMAKE_COMMAND} -E make_directory ${COVERAGE_REPORT_DIR}
-                               COMMAND ${GENHTML_EXECUTABLE} --legend --show-details -t "${PROJECT_NAME} test coverage" -o ${COVERAGE_REPORT_DIR} ${COVERAGE_FILTERED_FILE}
-                               DEPENDS ${COVERAGE_FILTERED_FILE}
-                               COMMENT "Generating HTML coverage report in ${COVERAGE_REPORT_DIR}"
-                               VERBATIM)
-                               
-            ADD_CUSTOM_TARGET(coverage-html
-                              DEPENDS ${COVERAGE_REPORT_DIR})
-                              
-        ENDIF()
-        
-        # xml coverage report
-        IF(GCOVR_FOUND)
-        
-            MESSAGE(STATUS "Enabling XML coverage report")
-        
-            # gcovr cannot write directly to a file so the execution needs to
-            # be wrapped in a cmake file that generates the file output
-            FILE(WRITE ${COVERAGE_XML_COMMAND_FILE}
-                 "SET(ENV{LANG} en)\n")
-            FILE(APPEND ${COVERAGE_XML_COMMAND_FILE}
-                "EXECUTE_PROCESS(COMMAND \"${GCOVR_EXECUTABLE}\" --exclude=3rd_party.* --exclude=tests.* --exclude=obj-.* --exclude=cmake.* --exclude=include.mir_test.* --exclude=include.mir_test_doubles.* --exclude=include.mir_test_framework.* -c \"${CMAKE_GCOV}\" -x -r \"${CMAKE_SOURCE_DIR}\" OUTPUT_FILE \"${COVERAGE_XML_FILE}\" WORKING_DIRECTORY \"${CMAKE_BINARY_DIR}\")\n")
-        
-            ADD_CUSTOM_COMMAND(OUTPUT ${COVERAGE_XML_FILE}
-                               COMMAND ${CMAKE_COMMAND} ARGS -P ${COVERAGE_XML_COMMAND_FILE}
-                               COMMENT "Generating coverage XML report"
-                               VERBATIM)
-                               
-            ADD_CUSTOM_TARGET(coverage-xml
-                              DEPENDS ${COVERAGE_XML_FILE})
-        
-        ENDIF()
-        
-        # provide a global coverage target executing both steps if available
-        SET(GLOBAL_DEPENDS "")
-        IF(LCOV_FOUND)
-            LIST(APPEND GLOBAL_DEPENDS ${COVERAGE_REPORT_DIR})
-        ENDIF()
-        IF(GCOVR_FOUND)
-            LIST(APPEND GLOBAL_DEPENDS ${COVERAGE_XML_FILE})
-        ENDIF()
-        IF(LCOV_FOUND OR GCOVR_FOUND)
-            ADD_CUSTOM_TARGET(coverage
-                              DEPENDS ${GLOBAL_DEPENDS})
-        ENDIF()
-                          
-    ENDIF()
-
-ENDFUNCTION()   
diff --git a/cmake/FindGtest.cmake b/cmake/FindGtest.cmake
deleted file mode 100644
index 25350d5..0000000
--- a/cmake/FindGtest.cmake
+++ /dev/null
@@ -1,67 +0,0 @@
-include(ExternalProject)
-include(FindPackageHandleStandardArgs)
-
-#gtest
-if (EXISTS /usr/src/googletest)
-    set (USING_GOOGLETEST_1_8 TRUE)
-    set (GTEST_INSTALL_DIR /usr/src/googletest/googletest/include)
-else()
-    set(GTEST_INSTALL_DIR /usr/src/gmock/gtest/include)
-endif()
-find_path(GTEST_INCLUDE_DIR gtest/gtest.h
-            HINTS ${GTEST_INSTALL_DIR})
-
-#gmock
-find_path(GMOCK_INSTALL_DIR CMakeLists.txt
-          HINTS /usr/src/googletest /usr/src/gmock)
-if(${GMOCK_INSTALL_DIR} STREQUAL "GMOCK_INSTALL_DIR-NOTFOUND")
-    message(FATAL_ERROR "google-mock package not found")
-endif()
-
-find_path(GMOCK_INCLUDE_DIR gmock/gmock.h)
-
-if (USING_GOOGLETEST_1_8)
-  set(GMOCK_BASE_BINARY_DIR ${CMAKE_BINARY_DIR}/gmock/libs)
-  set(GMOCK_BINARY_DIR ${GMOCK_BASE_BINARY_DIR}/googlemock)
-  set(GTEST_BINARY_DIR ${GMOCK_BINARY_DIR}/gtest)
-else()
-  set(GMOCK_BASE_BINARY_DIR ${CMAKE_BINARY_DIR}/gmock/libs)
-  set(GMOCK_BINARY_DIR ${GMOCK_BASE_BINARY_DIR})
-  set(GTEST_BINARY_DIR ${GMOCK_BINARY_DIR}/gtest)
-endif()
-
-set(GTEST_CMAKE_ARGS "")
-if (${MIR_IS_CROSS_COMPILING})
-    set(GTEST_CMAKE_ARGS
-        -DCMAKE_TOOLCHAIN_FILE=${CMAKE_MODULE_PATH}/LinuxCrossCompile.cmake)
-endif()
-
-if (USING_GOOGLETEST_1_8)
-  list(APPEND GTEST_CMAKE_ARGS -DBUILD_GTEST=ON)
-endif()
-
-ExternalProject_Add(
-    GMock
-    #where to build in source tree
-    PREFIX ${GMOCK_PREFIX}
-    #where the source is external to the project
-    SOURCE_DIR ${GMOCK_INSTALL_DIR}
-    #forward the compilers to the subproject so cross-arch builds work
-    CMAKE_ARGS ${GTEST_CMAKE_ARGS}
-    BINARY_DIR ${GMOCK_BASE_BINARY_DIR}
-
-    #we don't need to install, so skip
-    INSTALL_COMMAND ""
-)
-
-set(GMOCK_LIBRARY ${GMOCK_BINARY_DIR}/libgmock.a)
-set(GMOCK_MAIN_LIBRARY ${GMOCK_BINARY_DIR}/libgmock_main.a)
-set(GMOCK_BOTH_LIBRARIES ${GMOCK_LIBRARY} ${GMOCK_MAIN_LIBRARY})
-set(GTEST_LIBRARY ${GTEST_BINARY_DIR}/libgtest.a)
-set(GTEST_MAIN_LIBRARY ${GTEST_BINARY_DIR}/libgtest_main.a)
-set(GTEST_BOTH_LIBRARIES ${GTEST_LIBRARY} ${GTEST_MAIN_LIBRARY})
-set(GTEST_ALL_LIBRARIES ${GTEST_BOTH_LIBRARIES} ${GMOCK_BOTH_LIBRARIES})
-
-find_package_handle_standard_args(GTest  DEFAULT_MSG
-                                    GMOCK_INCLUDE_DIR
-                                    GTEST_INCLUDE_DIR)
diff --git a/cmake/Findgcovr.cmake b/cmake/Findgcovr.cmake
deleted file mode 100644
index e4c43fe..0000000
--- a/cmake/Findgcovr.cmake
+++ /dev/null
@@ -1,31 +0,0 @@
-# - Find gcovr scrip 
-# Will define:
-#
-# GCOVR_EXECUTABLE - the gcovr script
-#
-# Uses:
-#
-# GCOVR_ROOT - root to search for the script
-#
-# Copyright (C) 2011 by Johannes Wienke <jwienke at techfak dot uni-bielefeld dot de>
-#
-# This program is free software; you can redistribute it
-# and/or modify it under the terms of the GNU General
-# Public License as published by the Free Software Foundation;
-# either version 2, or (at your option)
-# any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-
-INCLUDE(FindPackageHandleStandardArgs)
-
-FIND_PROGRAM(GCOVR_EXECUTABLE gcovr HINTS ${GCOVR_ROOT} "${GCOVR_ROOT}/bin")
-
-FIND_PACKAGE_HANDLE_STANDARD_ARGS(gcovr DEFAULT_MSG GCOVR_EXECUTABLE)
-
-# only visible in advanced view
-MARK_AS_ADVANCED(GCOVR_EXECUTABLE)
diff --git a/cmake/GSettings.cmake b/cmake/GSettings.cmake
deleted file mode 100644
index e4da12b..0000000
--- a/cmake/GSettings.cmake
+++ /dev/null
@@ -1,41 +0,0 @@
-# GSettings.cmake, CMake macros written for Marlin, feel free to re-use them.
-
-option (GSETTINGS_LOCALINSTALL "Install GSettings Schemas locally instead of to the GLib prefix" ${LOCAL_INSTALL})
-
-option (GSETTINGS_COMPILE "Compile GSettings Schemas after installation" ${GSETTINGS_LOCALINSTALL})
-
-if(GSETTINGS_LOCALINSTALL)
-    message(STATUS "GSettings schemas will be installed locally.")
-endif()
-
-if(GSETTINGS_COMPILE)
-    message(STATUS "GSettings shemas will be compiled.")
-endif()
-
-macro(add_schema SCHEMA_NAME)
-
-    # Have an option to not install the schema into where GLib is
-    if (GSETTINGS_LOCALINSTALL)
-        SET (GSETTINGS_DIR "${CMAKE_INSTALL_PREFIX}/share/glib-2.0/schemas/")
-    else (GSETTINGS_LOCALINSTALL)
-        execute_process (COMMAND ${PKG_CONFIG_EXECUTABLE} glib-2.0 --variable prefix OUTPUT_VARIABLE _glib_prefix OUTPUT_STRIP_TRAILING_WHITESPACE)
-        SET (GSETTINGS_DIR "${_glib_prefix}/share/glib-2.0/schemas/")
-    endif (GSETTINGS_LOCALINSTALL)
-
-    # Run the validator and error if it fails
-    execute_process (COMMAND ${PKG_CONFIG_EXECUTABLE} gio-2.0 --variable glib_compile_schemas  OUTPUT_VARIABLE _glib_comple_schemas OUTPUT_STRIP_TRAILING_WHITESPACE)
-    execute_process (COMMAND ${_glib_comple_schemas} --dry-run --schema-file=${CMAKE_CURRENT_SOURCE_DIR}/${SCHEMA_NAME} ERROR_VARIABLE _schemas_invalid OUTPUT_STRIP_TRAILING_WHITESPACE)
-
-    if (_schemas_invalid)
-      message (SEND_ERROR "Schema validation error: ${_schemas_invalid}")
-    endif (_schemas_invalid)
-
-    # Actually install and recomple schemas
-    message (STATUS "GSettings schemas will be installed into ${GSETTINGS_DIR}")
-    install (FILES ${CMAKE_CURRENT_SOURCE_DIR}/${SCHEMA_NAME} DESTINATION ${GSETTINGS_DIR} OPTIONAL)
-
-    if (GSETTINGS_COMPILE)
-        install (CODE "message (STATUS \"Compiling GSettings schemas\")")
-        install (CODE "execute_process (COMMAND ${_glib_comple_schemas} ${GSETTINGS_DIR})")
-    endif ()
-endmacro()
diff --git a/cmake/ParseArguments.cmake b/cmake/ParseArguments.cmake
deleted file mode 100644
index e13f671..0000000
--- a/cmake/ParseArguments.cmake
+++ /dev/null
@@ -1,52 +0,0 @@
-# Parse arguments passed to a function into several lists separated by
-# upper-case identifiers and options that do not have an associated list e.g.:
-#
-# SET(arguments
-#   hello OPTION3 world
-#   LIST3 foo bar
-#   OPTION2
-#   LIST1 fuz baz
-#   )
-# PARSE_ARGUMENTS(ARG "LIST1;LIST2;LIST3" "OPTION1;OPTION2;OPTION3" ${arguments})
-#
-# results in 7 distinct variables:
-#  * ARG_DEFAULT_ARGS: hello;world
-#  * ARG_LIST1: fuz;baz
-#  * ARG_LIST2:
-#  * ARG_LIST3: foo;bar
-#  * ARG_OPTION1: FALSE
-#  * ARG_OPTION2: TRUE
-#  * ARG_OPTION3: TRUE
-#
-# taken from http://www.cmake.org/Wiki/CMakeMacroParseArguments 
-
-MACRO(PARSE_ARGUMENTS prefix arg_names option_names)
-    SET(DEFAULT_ARGS)
-    FOREACH(arg_name ${arg_names})    
-        SET(${prefix}_${arg_name})
-    ENDFOREACH(arg_name)
-    FOREACH(option ${option_names})
-        SET(${prefix}_${option} FALSE)
-    ENDFOREACH(option)
-    
-    SET(current_arg_name DEFAULT_ARGS)
-    SET(current_arg_list)
-    FOREACH(arg ${ARGN})            
-        SET(larg_names ${arg_names})    
-        LIST(FIND larg_names "${arg}" is_arg_name)                   
-        IF (is_arg_name GREATER -1)
-            SET(${prefix}_${current_arg_name} ${current_arg_list})
-            SET(current_arg_name ${arg})
-            SET(current_arg_list)
-        ELSE (is_arg_name GREATER -1)
-            SET(loption_names ${option_names})    
-            LIST(FIND loption_names "${arg}" is_option)            
-            IF (is_option GREATER -1)
-                SET(${prefix}_${arg} TRUE)
-            ELSE (is_option GREATER -1)
-                SET(current_arg_list ${current_arg_list} ${arg})
-            ENDIF (is_option GREATER -1)
-        ENDIF (is_arg_name GREATER -1)
-    ENDFOREACH(arg)
-    SET(${prefix}_${current_arg_name} ${current_arg_list})
-ENDMACRO(PARSE_ARGUMENTS)
diff --git a/tests/CMakeLists.txt b/tests/CMakeLists.txt
index 967c84b..ec2cf59 100644
--- a/tests/CMakeLists.txt
+++ b/tests/CMakeLists.txt
@@ -14,7 +14,7 @@
 #
 # Authored by: Thomas Voss <thomas.voss@canonical.com>
 
-find_package(Gtest REQUIRED)
+find_package(GMock REQUIRED)
 enable_testing()
 
 add_definitions(-DQT_NO_KEYWORDS)
@@ -28,7 +28,6 @@ include_directories (
   ${CMAKE_BINARY_DIR}/src
   ${CMAKE_BINARY_DIR}/src/com/ubuntu/content
   ${GMOCK_INCLUDE_DIR}
-  ${GTEST_INCLUDE_DIR}
   ${MIRCLIENT_INCLUDE_DIR}
 )
 
diff --git a/tests/acceptance-tests/CMakeLists.txt b/tests/acceptance-tests/CMakeLists.txt
index 8f7007e..784cf1d 100644
--- a/tests/acceptance-tests/CMakeLists.txt
+++ b/tests/acceptance-tests/CMakeLists.txt
@@ -39,7 +39,7 @@ set(TESTS
 )
 
 set(TEST_LIBS
-  ${GMOCK_LIBRARY}
+  ${GMOCK_LIBRARIES}
   ${GTEST_BOTH_LIBRARIES}
   content-hub
 )
@@ -83,7 +83,7 @@ add_executable(
 )
 
 target_link_libraries(test_registry_updater Qt5::Core Qt5::Gui Qt5::DBus Qt5::Test)
-target_link_libraries(test_registry_updater content-hub ${GTEST_ALL_LIBRARIES} ${GSETTINGS_LDFLAGS})
+target_link_libraries(test_registry_updater ${TEST_LIBS} ${GSETTINGS_LDFLAGS})
 add_test(NAME test_registry_updater COMMAND dbus-test-runner --task ${CMAKE_CURRENT_BINARY_DIR}/test_registry_updater)
 
 SET_TESTS_PROPERTIES(test_registry_updater
-- 
2.20.1

