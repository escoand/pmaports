# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer:
pkgname=unity8
pkgver=0_git20180919
_commit=87aa3950875c9cb614b33919dea08ae3ca16585b
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://unity8.io"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects settings-components gsettings-ubuntu-touch-schemas"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev unity-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev ubuntu-app-launch-dev ubuntu-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev ubuntu-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz"
source="$pkgname-$_commit.tar.gz::https://github.com/ubports/$pkgname/archive/$_commit.tar.gz
		AndroidAway.patch
		NoDpkgParse.patch
		use_cmake_extras_qmlplugins.patch
		fix_linking.patch
		musl_includes.patch
		qmltestrunner.patch
		0001-Don-t-fail-silently-when-qdbusxml2cpp-is-missing.patch
		temp.patch"
subpackages="$pkgname-lang"
options="!check" # Fails
builddir="$srcdir/$pkgname-$_commit"

prepare() {
	default_prepare
	mkdir "$builddir"/build
}

build() {
	cd "$builddir"/build
	cmake \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var ..
	make
}

check() {
	cd "$builddir"/build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	cd "$builddir"/build
	make DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	rm -r "$pkgdir"/usr/lib/unity8/qml/mocks/QMenuModel/
}

sha512sums="811fc073ad77ec2991d968fe6784dd4c9d4dee1d2ef37a52cbb8f20f997085a31fded0e3b20ea603bf70a1e823aa000ee5df4a965e2590cfec9ef3807f390e14  unity8-87aa3950875c9cb614b33919dea08ae3ca16585b.tar.gz
b81f32c9fd292852092fa8d035d3e518f2ffa56ef45b55c1452b1bd52555916ed682b2e05c3b9c26846f7b2d1ce61b03774f9deed8049a94fa9204ece1f15b0d  AndroidAway.patch
ca47a0de11c91bfcbcd9dd873b603e8833078ad552d3dc3c938e2ceaf24331578410260ab886609b4afe12058e4f9b6988b11437f73dc40920d77512e593e7e3  NoDpkgParse.patch
7df1d7ca339ca80be25b197dd8aa2fbe40553c69c5df2875883e3feef2fda681673eaa6207696a4ee36bd4879372bd4bb761b105f66417628ddd279d1bbec58b  use_cmake_extras_qmlplugins.patch
d29f0965320ed3b8630caddb64ef1e1dfa16f84db27f98aacdca4b31cc71deedc96d6712ab0d3512725544bc976ffd744618e5255a6fad8d0235b1809b51d3c6  fix_linking.patch
5652fd6905df5ef1e61830702566d4238be90517184e060c066410064f8abdc1897f80cd091043567e906aa36a2cc11abc88d762c5879de1ac45ca50777d1e6f  musl_includes.patch
d027c9c8426652e600597ffa20feb9336ca0ebade084f90d8c080bed5025f6b24a643bc174dec021d2345cf5e4cbd281e32c0d314d4e9f64fc1cd2e2782e0bab  qmltestrunner.patch
fb31f383f9e42167181d4e62ac965a7fe88de0c005e4f763a046c78b322952f8063ff582eed55eeabe844a0073d09c98c50e21666fcf1ff75acfc00ad5403733  0001-Don-t-fail-silently-when-qdbusxml2cpp-is-missing.patch
a86c5077791f7b2a73e178c28443e32f29980017603de116421130950979c64515e67bdef6bdc02aa33a00522d0eb328f9ae1dc653e6e0a7370a2be9738af5fc  temp.patch"
