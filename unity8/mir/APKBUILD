# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=mir
pkgver=1.0.0
pkgrel=0
pkgdesc="Canonical's display server"
url="https://mir-server.io"
arch="all"
license="GPL-2.0 GPL-3.0 LGPL-2.1 LGPL-3.0"
depends="xkeyboard-config dmz-cursor-theme ttf-freefont"
depends_dev="boost-dev mesa-dev glm-dev protobuf-dev glog-dev gflags-dev eudev-dev glib-dev wayland-dev libepoxy-dev nettle-dev libinput-dev
	capnproto-dev libxml++-2.6-dev py3-pillow freetype-dev libevdev-dev umockdev-dev lttng-ust-dev yaml-cpp-dev libxcursor-dev"
makedepends="$depends_dev cmake libxkbcommon-dev"
source="https://github.com/MirServer/mir/releases/download/v$pkgver/mir-$pkgver.tar.xz
	https://raw.githubusercontent.com/capnproto/capnproto/04fd66e2992a3ed38d686642a3c479a7f3e131c9/c%2B%2B/cmake/FindCapnProto.cmake
	fix-musl-errors.patch
	replace-bash-for-env.patch
	0001-Revert-Default-linker-to-gold.patch"
subpackages="$pkgname-dev"
options="!check" # Some tests fail

prepare() {
	default_prepare

	cp "$srcdir"/FindCapnProto.cmake "$builddir"/cmake/
}

build() {
	cd "$builddir"
	cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCMAKE_INSTALL_LIBDIR="lib/" -DMIR_ENABLE_TESTS=OFF
	cmake --build ./
}

check() {
	cd "$builddir"
	GTEST_OUTPUT=xml:./
	bin/mir_acceptance_tests
	bin/mir_integration_tests
	bin/mir_unit_tests
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir/" install
}
sha512sums="af13707fca4c3961f23e0dd7d202b5aaae587e251af897e4720537f36158013bf4a6999ba162753569f5b53d3e90d45090268630ceff82ed9d7b5f8086f71531  mir-1.0.0.tar.xz
6b74c3584d535d3e36afda8b128cc829da6a5518663d12cb57b70f1cb685e97999b6398f21698c9d87cf5481a05d05a387e94191ca7f82c919e557fadf520b27  FindCapnProto.cmake
3b763de0e466f5ddd1985c89144fc03fa00606bf616ef1333064c526594109b74f48e595aba2cc76e85bf667ba9bacbaf602b0a133d70c694c76b8e632dd4da7  fix-musl-errors.patch
55844af6f9c1cf38d0e068513389e22aaaddc477eed538dbebe5fc757d3ad9c464e6c88ebf587d4b36bea91cf25411989de59ba863b362c0010535721016e38b  replace-bash-for-env.patch
7d1c7a06c05e30ded8a38ad302979a95b09ecca6bcf13dedc39948609cb193e19bb76a11f0f70f573a2e4dd688106af0539a06671063ee084ecf3f5ce69cc68e  0001-Revert-Default-linker-to-gold.patch"
